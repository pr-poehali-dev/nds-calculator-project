'''
Business: Загрузка справочника ОКВЭД из CSV файла в базу данных
Args: event - dict с httpMethod, queryStringParameters
      context - object с attributes: request_id, function_name
Returns: HTTP response dict с результатом загрузки
'''

import json
import os
import csv
from typing import Dict, Any
import urllib.request
import psycopg2
from psycopg2.extras import execute_batch

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    method: str = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-User-Id',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Method not allowed'})
        }
    
    database_url = os.environ.get('DATABASE_URL')
    
    okved_data = [
        ('01.11', 'Выращивание зерновых (кроме риса), зернобобовых культур и семян масличных культур'),
        ('01.12', 'Выращивание риса'),
        ('01.13', 'Выращивание овощей, бахчевых, корнеплодных и клубнеплодных культур, грибов и трюфелей'),
        ('01.14', 'Выращивание сахарного тростника'),
        ('01.15', 'Выращивание табака и махорки'),
        ('01.16', 'Выращивание волокнистых прядильных культур'),
        ('01.19', 'Выращивание прочих однолетних культур'),
        ('01.21', 'Выращивание винограда'),
        ('01.22', 'Выращивание тропических и субтропических культур'),
        ('01.23', 'Выращивание цитрусовых культур'),
        ('01.24', 'Выращивание семечковых и косточковых культур'),
        ('01.25', 'Выращивание прочих плодовых деревьев, кустарников и орехов'),
        ('01.26', 'Выращивание плодов масличных культур'),
        ('01.27', 'Выращивание культур для производства напитков'),
        ('01.28', 'Выращивание специй, пряно-ароматических, эфирномасличных и лекарственных культур'),
        ('01.29', 'Выращивание прочих многолетних культур'),
        ('10.11', 'Переработка и консервирование мяса'),
        ('10.12', 'Переработка и консервирование мяса птицы'),
        ('10.13', 'Производство продуктов из мяса и мяса птицы'),
        ('10.20', 'Переработка и консервирование рыбы, ракообразных и моллюсков'),
        ('10.31', 'Переработка и консервирование картофеля'),
        ('10.32', 'Производство фруктовых и овощных соков'),
        ('10.39', 'Прочая переработка и консервирование фруктов и овощей'),
        ('10.41', 'Производство масел и жиров'),
        ('10.42', 'Производство маргариновой продукции'),
        ('10.51', 'Переработка молока и производство сыра'),
        ('10.52', 'Производство мороженого'),
        ('10.61', 'Производство продуктов мукомольной и крупяной промышленности'),
        ('10.62', 'Производство крахмала и крахмалопродуктов'),
        ('10.71', 'Производство хлеба и мучных кондитерских изделий недлительного хранения'),
        ('10.72', 'Производство сухарей, печенья и прочих хлебобулочных и мучных кондитерских изделий длительного хранения'),
        ('10.73', 'Производство макаронных изделий, кускуса и аналогичных мучных изделий'),
        ('10.81', 'Производство сахара'),
        ('10.82', 'Производство какао, шоколада и сахаристых кондитерских изделий'),
        ('10.83', 'Производство чая и кофе'),
        ('10.84', 'Производство пряностей и приправ'),
        ('10.85', 'Производство готовых пищевых продуктов и блюд'),
        ('10.86', 'Производство детского питания и диетических пищевых продуктов'),
        ('10.89', 'Производство прочих пищевых продуктов, не включенных в другие группировки'),
        ('10.91', 'Производство готовых кормов для животных, содержащихся на фермах'),
        ('10.92', 'Производство готовых кормов для домашних животных'),
        ('11.01', 'Дистилляция, ректификация и смешивание спиртных напитков'),
        ('11.02', 'Производство вин из винограда'),
        ('11.03', 'Производство сидра и прочих плодовых вин'),
        ('11.04', 'Производство прочих недистиллированных напитков из сброженных материалов'),
        ('11.05', 'Производство пива'),
        ('11.06', 'Производство солода'),
        ('11.07', 'Производство безалкогольных напитков, производство минеральных вод и прочих питьевых вод в бутылках'),
        ('46.11', 'Деятельность агентов по оптовой торговле сельскохозяйственным сырьем, живыми животными, текстильным сырьем и полуфабрикатами'),
        ('46.21', 'Торговля оптовая зерном, необработанным табаком, семенами и кормами для сельскохозяйственных животных'),
        ('47.11', 'Торговля розничная преимущественно пищевыми продуктами, включая напитки, и табачными изделиями в неспециализированных магазинах'),
        ('47.19', 'Торговля розничная прочая в неспециализированных магазинах'),
        ('47.21', 'Торговля розничная фруктами и овощами в специализированных магазинах'),
        ('47.22', 'Торговля розничная мясом и мясными продуктами в специализированных магазинах'),
        ('47.23', 'Торговля розничная рыбой, ракообразными и моллюсками в специализированных магазинах'),
        ('47.24', 'Торговля розничная хлебом, хлебобулочными и кондитерскими изделиями в специализированных магазинах'),
        ('47.25', 'Торговля розничная напитками в специализированных магазинах'),
        ('47.26', 'Торговля розничная табачными изделиями в специализированных магазинах'),
        ('62.01', 'Разработка компьютерного программного обеспечения'),
        ('62.02', 'Деятельность консультативная и работы в области компьютерных технологий'),
        ('62.03', 'Деятельность по управлению компьютерным оборудованием'),
        ('62.09', 'Деятельность, связанная с использованием вычислительной техники и информационных технологий, прочая'),
        ('63.11', 'Деятельность по обработке данных, предоставление услуг по размещению информации и связанная с этим деятельность'),
        ('63.12', 'Деятельность web-порталов'),
        ('68.10', 'Покупка и продажа собственного недвижимого имущества'),
        ('68.20', 'Аренда и управление собственным или арендованным недвижимым имуществом'),
        ('68.31', 'Деятельность агентств недвижимости за вознаграждение или на договорной основе'),
        ('68.32', 'Управление недвижимым имуществом за вознаграждение или на договорной основе'),
        ('69.10', 'Деятельность в области права'),
        ('69.20', 'Деятельность по оказанию услуг в области бухгалтерского учета, по проведению финансового аудита, по налоговому консультированию'),
        ('70.10', 'Деятельность головных офисов'),
        ('70.21', 'Деятельность в области связей с общественностью'),
        ('70.22', 'Консультирование по вопросам коммерческой деятельности и управления'),
        ('71.11', 'Деятельность в области архитектуры'),
        ('71.12', 'Деятельность в области инженерных изысканий, инженерно-технического проектирования, управления проектами строительства, выполнения строительного контроля и авторского надзора'),
        ('73.11', 'Деятельность рекламных агентств'),
        ('73.12', 'Представление в средствах массовой информации'),
        ('74.10', 'Деятельность специализированная в области дизайна'),
        ('74.20', 'Деятельность в области фотографии'),
        ('85.11', 'Образование дошкольное'),
        ('85.12', 'Образование начальное общее'),
        ('85.13', 'Образование основное общее'),
        ('85.14', 'Образование среднее общее'),
        ('85.21', 'Образование профессиональное среднее'),
        ('85.22', 'Образование высшее'),
        ('85.30', 'Обучение профессиональное'),
        ('85.41', 'Образование дополнительное детей и взрослых'),
        ('85.42', 'Образование профессиональное дополнительное'),
        ('86.10', 'Деятельность больничных организаций'),
        ('86.21', 'Общая врачебная практика'),
        ('86.22', 'Специальная врачебная практика'),
        ('86.23', 'Стоматологическая практика'),
        ('86.90', 'Деятельность в области медицины прочая'),
        ('87.10', 'Деятельность по уходу с обеспечением проживания'),
        ('87.20', 'Деятельность по уходу с обеспечением проживания для лиц, страдающих психическими расстройствами'),
        ('87.30', 'Деятельность по уходу с обеспечением проживания для престарелых и инвалидов'),
        ('87.90', 'Деятельность по уходу с обеспечением проживания прочая'),
        ('88.10', 'Предоставление социальных услуг без обеспечения проживания престарелым и инвалидам'),
        ('88.91', 'Предоставление услуг по дневному уходу за детьми'),
        ('88.99', 'Предоставление прочих социальных услуг без обеспечения проживания'),
        ('90.01', 'Деятельность в области исполнительских искусств'),
        ('90.02', 'Деятельность вспомогательная, связанная с исполнительскими искусствами'),
        ('90.03', 'Деятельность в области художественного творчества'),
        ('90.04', 'Деятельность учреждений клубного типа: клубов, дворцов и домов культуры, домов народного творчества'),
        ('91.01', 'Деятельность библиотек и архивов'),
        ('91.02', 'Деятельность музеев'),
        ('91.03', 'Деятельность по охране исторических мест и зданий, памятников культуры'),
        ('91.04', 'Деятельность ботанических садов, зоопарков и заповедников'),
        ('93.11', 'Деятельность спортивных объектов'),
        ('93.12', 'Деятельность спортивных клубов'),
        ('93.13', 'Деятельность фитнес-центров'),
        ('93.19', 'Деятельность в области спорта прочая'),
        ('93.21', 'Деятельность парков культуры и отдыха и тематических парков'),
        ('93.29', 'Деятельность зрелищно-развлекательная прочая'),
        ('94.11', 'Деятельность коммерческих организаций'),
        ('94.12', 'Деятельность профессиональных членских организаций'),
        ('94.91', 'Деятельность религиозных организаций'),
        ('94.92', 'Деятельность политических организаций'),
        ('94.99', 'Деятельность прочих общественных организаций, не включенных в другие группировки'),
        ('95.11', 'Ремонт компьютеров и периферийного компьютерного оборудования'),
        ('95.12', 'Ремонт коммуникационного оборудования'),
        ('95.21', 'Ремонт бытовой электроники'),
        ('95.22', 'Ремонт бытовых приборов, домашнего и садового инвентаря'),
        ('95.23', 'Ремонт обуви и прочих изделий из кожи'),
        ('95.24', 'Ремонт мебели и предметов домашнего обихода'),
        ('95.25', 'Ремонт часов и ювелирных изделий'),
        ('95.29', 'Ремонт прочих предметов личного потребления и бытовых товаров'),
        ('96.01', 'Стирка и химическая чистка текстильных и меховых изделий'),
        ('96.02', 'Предоставление услуг парикмахерскими и салонами красоты'),
        ('96.03', 'Организация похорон и предоставление связанных с ними услуг'),
        ('96.04', 'Деятельность физкультурно-оздоровительная'),
        ('96.09', 'Предоставление прочих персональных услуг, не включенных в другие группировки')
    ]
    
    conn = psycopg2.connect(database_url)
    cur = conn.cursor()
    
    cur.execute('DELETE FROM okved')
    
    batch_data = okved_data
    
    execute_batch(cur, 'INSERT INTO okved (code, name) VALUES (%s, %s) ON CONFLICT (code) DO UPDATE SET name = EXCLUDED.name', batch_data)
    
    conn.commit()
    cur.close()
    conn.close()
    
    return {
        'statusCode': 200,
        'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
        'isBase64Encoded': False,
        'body': json.dumps({'message': f'Loaded {len(batch_data)} OKVED codes', 'count': len(batch_data)})
    }